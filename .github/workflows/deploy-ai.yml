# .github/workflows/deploy-ai.yml

name: Deploy AI Server to Tokyo GPU EC2

on:
  push:
    branches:
      - dev
    paths:
      - 'ai-fastapi/**'
      - 'ai-vton-server/**'
      - '.github/workflows/deploy-ai.yml'

concurrency:
  group: deploy-ai-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1
      
      - name: Cancel Previous Deployments
        run: |
          echo "üîç Checking for running deployments..."
          
          RUNNING=$(aws ssm list-commands \
            --instance-id "i-00f17116a4704e13f" \
            --max-results 5 \
            --filters "key=Status,value=InProgress" \
            --query 'Commands[].CommandId' \
            --output text 2>/dev/null || echo "")
          
          if [ ! -z "$RUNNING" ]; then
            echo "‚ö†Ô∏è  Found running deployment(s), cancelling..."
            for CMD_ID in $RUNNING; do
              aws ssm cancel-command \
                --command-id "$CMD_ID" \
                --instance-ids "i-00f17116a4704e13f" || true
              echo "Cancelled: $CMD_ID"
            done
            echo "Waiting 10 seconds for cleanup..."
            sleep 10
          else
            echo "‚úÖ No running deployments found"
          fi
      
      - name: Deploy to Tokyo GPU EC2
        timeout-minutes: 15
        run: |
          echo "üöÄ Starting AI server deployment..."
          echo "Target: Tokyo GPU EC2 (i-00f17116a4704e13f)"
          echo "Branch: dev"
          echo ""
          
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "i-00f17116a4704e13f" \
            --parameters 'commands=[
              "#!/bin/bash",
              "set -e",
              "echo \"============================================\"",
              "echo \"üöÄ AI Server Deployment Started\"",
              "echo \"============================================\"",
              "echo \"Timestamp: $(date)\"",
              "echo \"Instance: $(hostname)\"",
              "echo \"User: $(whoami)\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 1: Cleanup previous npm processes\"",
              "sudo pkill -9 npm 2>/dev/null || true",
              "sleep 2",
              "echo \"‚úÖ Cleanup complete\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 2: Switch to ubuntu user and deploy\"",
              "sudo su - ubuntu << '\''DEPLOY_SCRIPT'\''",
              "set -e",
              "",
              "echo \"Current user: $(whoami)\"",
              "echo \"Working directory: $(pwd)\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 3: Navigate to project\"",
              "cd /home/ubuntu/app || { echo \"‚ùå Failed to cd to app\"; exit 1; }",
              "echo \"‚úÖ In app directory\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 4: Git operations\"",
              "echo \"Fetching from origin...\"",
              "git fetch origin || { echo \"‚ùå Git fetch failed\"; exit 1; }",
              "",
              "echo \"Current branch: $(git branch --show-current)\"",
              "echo \"Resetting to origin/dev...\"",
              "git reset --hard origin/dev || { echo \"‚ùå Git reset failed\"; exit 1; }",
              "",
              "echo \"Latest commit: $(git log -1 --oneline)\"",
              "echo \"‚úÖ Git operations complete\"",
              "echo \"\"",
              "",
              "echo \"============================================\"",
              "echo \"üîµ Deploying AI FastAPI Server (Port 8000)\"",
              "echo \"============================================\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 5: Navigate to ai-fastapi\"",
              "cd ai-fastapi || { echo \"‚ùå ai-fastapi directory not found\"; exit 1; }",
              "echo \"Current directory: $(pwd)\"",
              "echo \"‚úÖ In ai-fastapi directory\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 6: Install Python dependencies (ai-fastapi)\"",
              "echo \"Installing requirements...\"",
              "pip3 install -r requirements.txt --break-system-packages || { echo \"‚ùå pip install failed\"; exit 1; }",
              "echo \"‚úÖ Dependencies installed\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 7: Restart AI FastAPI server with PM2\"",
              "echo \"Stopping existing process...\"",
              "pm2 stop ai-fastapi 2>/dev/null || echo \"No process to stop\"",
              "pm2 delete ai-fastapi 2>/dev/null || echo \"No process to delete\"",
              "",
              "echo \"Starting new process with uvicorn...\"",
              "pm2 start uvicorn --name ai-fastapi --interpreter python3 -- main:app --host 0.0.0.0 --port 8000 || { echo \"‚ùå PM2 start failed\"; exit 1; }",
              "",
              "echo \"‚úÖ AI FastAPI server started\"",
              "echo \"\"",
              "",
              "echo \"============================================\"",
              "echo \"üü¢ Deploying VTON API Server (Port 8001)\"",
              "echo \"============================================\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 8: Navigate to virtual-try/IDM-VTON directory\"",
              "cd /home/ubuntu/app/virtual-try/IDM-VTON || { echo \"‚ùå IDM-VTON directory not found\"; exit 1; }",
              "echo \"Current directory: $(pwd)\"",
              "echo \"‚úÖ In IDM-VTON directory\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 9: Initialize Conda environment\"",
              "source /home/ubuntu/.bashrc || true",
              "export PATH=\"/home/ubuntu/miniconda3/bin:$PATH\"",
              "eval \"$(/home/ubuntu/miniconda3/bin/conda shell.bash hook)\" || { echo \"‚ùå Conda init failed\"; exit 1; }",
              "echo \"‚úÖ Conda initialized\"",
              "echo \"Conda path: $(which conda)\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 10: Activate vton conda environment\"",
              "conda activate vton || { echo \"‚ùå Conda activate vton failed\"; exit 1; }",
              "echo \"‚úÖ Conda environment '\''vton'\'' activated\"",
              "echo \"Python: $(which python)\"",
              "echo \"Python version: $(python --version)\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 11: Install/Update Python dependencies (VTON)\"",
              "if [ -f requirements.txt ]; then",
              "  echo \"Installing VTON requirements...\"",
              "  pip install -r requirements.txt || echo \"‚ö†Ô∏è  Some dependencies may have failed\"",
              "else",
              "  echo \"‚ÑπÔ∏è  No requirements.txt found, skipping\"",
              "fi",
              "echo \"\"",
              "",
              "echo \"üìå Step 12: Restart VTON API server with PM2\"",
              "echo \"Stopping existing VTON process...\"",
              "pm2 stop vton-api 2>/dev/null || echo \"No process to stop\"",
              "pm2 delete vton-api 2>/dev/null || echo \"No process to delete\"",
              "",
              "echo \"Starting new VTON API process with PM2...\"",
              "VTON_PYTHON=\"/home/ubuntu/miniconda3/envs/vton/bin/python\"",
              "echo \"Python path: $VTON_PYTHON\"",
              "echo \"Working directory: $(pwd)\"",
              "echo \"Starting: pm2 start $VTON_PYTHON --name vton-api -- api_server.py --port 8001\"",
              "",
              "pm2 start $VTON_PYTHON --name vton-api -- api_server.py --port 8001 || { echo \"‚ùå PM2 start failed\"; exit 1; }",
              "",
              "echo \"‚úÖ VTON API server started\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 13: Save PM2 configuration\"",
              "pm2 save",
              "echo \"‚úÖ PM2 configuration saved\"",
              "echo \"\"",
              "",
              "echo \"============================================\"",
              "echo \"üìä PM2 Status\"",
              "echo \"============================================\"",
              "pm2 list",
              "echo \"\"",
              "",
              "echo \"============================================\"",
              "echo \"üìã Recent Logs\"",
              "echo \"============================================\"",
              "echo \"\"",
              "echo \"üîµ AI FastAPI (last 5 lines):\"",
              "pm2 logs ai-fastapi --lines 5 --nostream || true",
              "echo \"\"",
              "echo \"üü¢ VTON API (last 5 lines):\"",
              "pm2 logs vton-api --lines 5 --nostream || true",
              "echo \"\"",
              "",
              "echo \"============================================\"",
              "echo \"üìå Step 14: Health Checks\"",
              "echo \"============================================\"",
              "echo \"Waiting 10 seconds for servers to start...\"",
              "sleep 10",
              "echo \"\"",
              "",
              "echo \"üîµ Testing AI FastAPI (port 8000)...\"",
              "AI_HEALTH=$(curl -s http://localhost:8000/health || echo \"failed\")",
              "if echo \"$AI_HEALTH\" | grep -q \"ok\"; then",
              "  echo \"‚úÖ AI FastAPI health check passed\"",
              "else",
              "  echo \"‚ö†Ô∏è  AI FastAPI health check failed or starting\"",
              "fi",
              "echo \"Response: $AI_HEALTH\"",
              "echo \"\"",
              "",
              "echo \"üü¢ Testing VTON API (port 8001)...\"",
              "VTON_HEALTH=$(curl -s http://localhost:8001/ || echo \"failed\")",
              "if echo \"$VTON_HEALTH\" | grep -q \"IDM-VTON\"; then",
              "  echo \"‚úÖ VTON API health check passed\"",
              "else",
              "  echo \"‚ö†Ô∏è  VTON API health check failed or starting\"",
              "fi",
              "echo \"Response: $VTON_HEALTH\"",
              "echo \"\"",
              "",
              "DEPLOY_SCRIPT",
              "",
              "echo \"\"",
              "echo \"============================================\"",
              "echo \"‚úÖ Deployment Complete\"",
              "echo \"============================================\"",
              "echo \"üîµ AI FastAPI: http://10.1.157.47:8000\"",
              "echo \"   Health: http://10.1.157.47:8000/health\"",
              "echo \"\"",
              "echo \"üü¢ VTON API: http://10.1.157.47:8001\"",
              "echo \"   Health: http://10.1.157.47:8001/\"",
              "echo \"============================================\""
            ]' \
            --timeout-seconds 900 \
            --comment "Deploy AI FastAPI and VTON API from GitHub Actions" \
            --output text \
            --query 'Command.CommandId')
          
          echo "üìù Command ID: $COMMAND_ID"
          echo ""
          echo "‚è≥ Waiting for deployment to complete..."
          echo ""
          
          MAX_ATTEMPTS=90
          DELAY=10
          ATTEMPT=0
          STATUS="Pending"
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            sleep $DELAY
            ATTEMPT=$((ATTEMPT + 1))
            
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "i-00f17116a4704e13f" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            if [ $((ATTEMPT % 6)) -eq 0 ]; then
              ELAPSED=$((ATTEMPT * DELAY))
              echo "[$ELAPSED seconds] Status: $STATUS"
            fi
            
            if [ "$STATUS" = "Success" ] || \
               [ "$STATUS" = "Failed" ] || \
               [ "$STATUS" = "Cancelled" ] || \
               [ "$STATUS" = "TimedOut" ]; then
              break
            fi
          done
          
          echo ""
          echo "================================================"
          echo "üìã Deployment Output"
          echo "================================================"
          
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-00f17116a4704e13f" \
            --query 'StandardOutputContent' \
            --output text 2>/dev/null || echo "No output available")
          
          echo "$OUTPUT"
          
          echo ""
          echo "================================================"
          echo "‚ùå Error Output (if any)"
          echo "================================================"
          
          ERROR=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-00f17116a4704e13f" \
            --query 'StandardErrorContent' \
            --output text 2>/dev/null || echo "No errors")
          
          if [ "$ERROR" != "None" ] && [ "$ERROR" != "No errors" ] && [ ! -z "$ERROR" ]; then
            echo "$ERROR"
          else
            echo "No errors detected"
          fi
          
          echo ""
          echo "================================================"
          echo "üìä Final Status: $STATUS"
          echo "================================================"
          
          if [ "$STATUS" != "Success" ]; then
            echo ""
            echo "‚ùå Deployment Failed!"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Deployment Successful!"
          echo ""
          echo "üéØ Deployed Services:"
          echo "   üîµ AI FastAPI: http://10.1.157.47:8000"
          echo "   üü¢ VTON API: http://10.1.157.47:8001"
          echo ""
        #test
