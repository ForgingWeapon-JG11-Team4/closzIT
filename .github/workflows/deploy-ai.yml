# .github/workflows/deploy-ai.yml

name: Deploy AI Server to Tokyo GPU EC2

on:
  push:
    branches:
      - dev
    paths:
      - 'ai-fastapi/**'
      - '.github/workflows/deploy-ai.yml'

concurrency:
  group: deploy-ai-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1
      
      - name: Cancel Previous Deployments
        run: |
          echo "üîç Checking for running deployments..."
          
          RUNNING=$(aws ssm list-commands \
            --instance-id "i-00f17116a4704e13f" \
            --max-results 5 \
            --filters "key=Status,value=InProgress" \
            --query 'Commands[].CommandId' \
            --output text 2>/dev/null || echo "")
          
          if [ ! -z "$RUNNING" ]; then
            echo "‚ö†Ô∏è  Found running deployment(s), cancelling..."
            for CMD_ID in $RUNNING; do
              aws ssm cancel-command \
                --command-id "$CMD_ID" \
                --instance-ids "i-00f17116a4704e13f" || true
              echo "Cancelled: $CMD_ID"
            done
            echo "Waiting 10 seconds for cleanup..."
            sleep 10
          else
            echo "‚úÖ No running deployments found"
          fi
      
      - name: Deploy to Tokyo GPU EC2
        timeout-minutes: 15
        run: |
          echo "üöÄ Starting AI server deployment..."
          echo "Target: Tokyo GPU EC2 (i-00f17116a4704e13f)"
          echo "Branch: dev"
          echo ""
          
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "i-00f17116a4704e13f" \
            --parameters 'commands=[
              "#!/bin/bash",
              "set -e",
              "echo \"============================================\"",
              "echo \"üöÄ AI Server Deployment Started\"",
              "echo \"============================================\"",
              "echo \"Timestamp: $(date)\"",
              "echo \"Instance: $(hostname)\"",
              "echo \"User: $(whoami)\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 1: Cleanup previous npm processes\"",
              "sudo pkill -9 npm 2>/dev/null || true",
              "sleep 2",
              "echo \"‚úÖ Cleanup complete\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 2: Switch to ubuntu user\"",
              "sudo su - ubuntu << '\''DEPLOY_SCRIPT'\''",
              "set -e",
              "",
              "echo \"Current user: $(whoami)\"",
              "echo \"Working directory: $(pwd)\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 3: Navigate to project\"",
              "cd /home/ubuntu/app || { echo \"‚ùå Failed to cd to app\"; exit 1; }",
              "echo \"‚úÖ In app directory\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 4: Git operations\"",
              "echo \"Fetching from origin...\"",
              "git fetch origin || { echo \"‚ùå Git fetch failed\"; exit 1; }",
              "",
              "echo \"Current branch: $(git branch --show-current)\"",
              "echo \"Resetting to origin/dev...\"",
              "git reset --hard origin/dev || { echo \"‚ùå Git reset failed\"; exit 1; }",
              "",
              "echo \"Latest commit: $(git log -1 --oneline)\"",
              "echo \"‚úÖ Git operations complete\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 5: Navigate to ai-fastapi\"",
              "cd ai-fastapi || { echo \"‚ùå ai-fastapi directory not found\"; exit 1; }",
              "echo \"Current directory: $(pwd)\"",
              "echo \"‚úÖ In ai-fastapi directory\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 6: Install Python dependencies\"",
              "echo \"Installing requirements...\"",
              "pip3 install -r requirements.txt --break-system-packages || { echo \"‚ùå pip install failed\"; exit 1; }",
              "echo \"‚úÖ Dependencies installed\"",
              "echo \"\"",
              "",
              "echo \"üìå Step 7: Restart AI server with PM2 (uvicorn)\"",
              "echo \"Stopping existing process...\"",
              "pm2 stop ai-fastapi 2>/dev/null || echo \"No process to stop\"",
              "pm2 delete ai-fastapi 2>/dev/null || echo \"No process to delete\"",
              "",
              "echo \"Starting new process with uvicorn...\"",
              "pm2 start uvicorn --name ai-fastapi --interpreter python3 -- main:app --host 0.0.0.0 --port 8000 || { echo \"‚ùå PM2 start failed\"; exit 1; }",
              "",
              "echo \"Saving PM2 configuration...\"",
              "pm2 save",
              "",
              "echo \"\"",
              "echo \"üìä PM2 Status:\"",
              "pm2 list",
              "",
              "echo \"\"",
              "echo \"üìã Recent logs (last 10 lines):\"",
              "pm2 logs ai-fastapi --lines 10 --nostream || true",
              "",
              "echo \"\"",
              "echo \"üìå Step 8: Health check\"",
              "echo \"Waiting 10 seconds for server to start...\"",
              "sleep 10",
              "",
              "echo \"Testing health endpoint...\"",
              "HEALTH_RESPONSE=$(curl -s http://localhost:8000/health || echo \"failed\")",
              "",
              "if echo \"$HEALTH_RESPONSE\" | grep -q \"ok\"; then",
              "  echo \"‚úÖ Health check passed\"",
              "  echo \"Response: $HEALTH_RESPONSE\"",
              "else",
              "  echo \"‚ö†Ô∏è  Health check failed or server starting\"",
              "  echo \"Response: $HEALTH_RESPONSE\"",
              "fi",
              "",
              "DEPLOY_SCRIPT",
              "",
              "echo \"\"",
              "echo \"============================================\"",
              "echo \"‚úÖ AI Server Deployment Complete\"",
              "echo \"============================================\"",
              "echo \"Server: http://10.1.157.47:8000\"",
              "echo \"Health: http://10.1.157.47:8000/health\"",
              "echo \"============================================\""
            ]' \
            --timeout-seconds 900 \
            --comment "Deploy AI FastAPI from GitHub Actions" \
            --output text \
            --query 'Command.CommandId')
          
          echo "üìù Command ID: $COMMAND_ID"
          echo ""
          echo "‚è≥ Waiting for deployment to complete..."
          echo ""
          
          MAX_ATTEMPTS=90
          DELAY=10
          ATTEMPT=0
          STATUS="Pending"
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            sleep $DELAY
            ATTEMPT=$((ATTEMPT + 1))
            
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "i-00f17116a4704e13f" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            if [ $((ATTEMPT % 6)) -eq 0 ]; then
              ELAPSED=$((ATTEMPT * DELAY))
              echo "[$ELAPSED seconds] Status: $STATUS"
            fi
            
            if [ "$STATUS" = "Success" ] || \
               [ "$STATUS" = "Failed" ] || \
               [ "$STATUS" = "Cancelled" ] || \
               [ "$STATUS" = "TimedOut" ]; then
              break
            fi
          done
          
          echo ""
          echo "================================================"
          echo "üìã Deployment Output"
          echo "================================================"
          
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-00f17116a4704e13f" \
            --query 'StandardOutputContent' \
            --output text 2>/dev/null || echo "No output available")
          
          echo "$OUTPUT"
          
          echo ""
          echo "================================================"
          echo "‚ùå Error Output (if any)"
          echo "================================================"
          
          ERROR=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-00f17116a4704e13f" \
            --query 'StandardErrorContent' \
            --output text 2>/dev/null || echo "No errors")
          
          if [ "$ERROR" != "None" ] && [ "$ERROR" != "No errors" ] && [ ! -z "$ERROR" ]; then
            echo "$ERROR"
          else
            echo "No errors detected"
          fi
          
          echo ""
          echo "================================================"
          echo "üìä Final Status: $STATUS"
          echo "================================================"
          
          if [ "$STATUS" != "Success" ]; then
            echo ""
            echo "‚ùå Deployment Failed!"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Deployment Successful!"
          echo ""
          echo "üéØ AI Server: http://10.1.157.47:8000"
          echo ""
