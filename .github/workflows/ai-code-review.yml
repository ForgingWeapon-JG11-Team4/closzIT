name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.js
            **/*.jsx
            **/*.ts
            **/*.tsx
            **/*.py
            **/*.java
            **/*.go
            **/*.css
            **/*.html

      - name: AI Code Review
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
            
            const { execSync } = require('child_process');
            let fullDiff = '';
            
            for (const file of changedFiles) {
              if (file.trim()) {
                try {
                  const diff = execSync(`git diff origin/${{ github.base_ref }}...HEAD -- "${file}"`, { encoding: 'utf-8' });
                  if (diff) {
                    fullDiff += '\n### File: ' + file + '\n```diff\n' + diff + '\n```\n';
                  }
                } catch (e) {
                  console.log('Skipping file: ' + file);
                }
              }
            }
            
            if (!fullDiff) {
              console.log('No code changes to review');
              return;
            }
            
            const prompt = '당신은 시니어 개발자입니다. 다음 코드 변경사항을 리뷰해주세요.\n\n' +
              '리뷰 형식:\n' +
              '## 코드 리뷰 요약\n' +
              '(전반적인 변경사항 평가)\n\n' +
              '## 잘된 부분\n' +
              '(좋은 코드 패턴이나 개선된 부분)\n\n' +
              '## 개선 제안\n' +
              '(버그 가능성, 성능 이슈, 코드 스타일 개선점 - 구체적인 라인과 함께)\n\n' +
              '## 추가 권장사항\n' +
              '(선택적 개선 아이디어)\n\n' +
              '변경사항:\n' + fullDiff;
            
            const response = await fetch('https://generativelanguage.googleapis. com/v1beta/models/gemini-flash-latest:generateContent?key=' + process.env.GEMINI_API_KEY, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                  temperature: 0.3,
                  maxOutputTokens: 2048
                }
              })
            });
            
            const result = await response.json();
            let reviewText = '## AI 코드 리뷰\n\n';
            
            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
              reviewText += result.candidates[0].content.parts[0].text;
            } else {
              reviewText += '리뷰를 생성하지 못했습니다.';
              console.log('API Response:', JSON.stringify(result));
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewText
            });
