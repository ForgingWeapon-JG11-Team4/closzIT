name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.js
            **/*.jsx
            **/*.ts
            **/*.tsx
            **/*.py
            **/*.java
            **/*.go
            **/*.css
            **/*.html

      - name: AI Code Review
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
            
            // Get diff for each file
            const { execSync } = require('child_process');
            let fullDiff = '';
            
            for (const file of changedFiles) {
              if (file.trim()) {
                try {
                  const diff = execSync(`git diff origin/${{ github.base_ref }}...HEAD -- "${file}"`, { encoding: 'utf-8' });
                  if (diff) {
                    fullDiff += `\n### File: ${file}\n\`\`\`diff\n${diff}\n\`\`\`\n`;
                  }
                } catch (e) {
                  console.log(`Skipping file: ${file}`);
                }
              }
            }
            
            if (!fullDiff) {
              console.log('No code changes to review');
              return;
            }
            
            // Call Gemini API
            const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + process.env.GEMINI_API_KEY, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: `ë‹¹ì‹ ì€ ì‹œë‹ˆì–´ ê°œë°œìì…ë‹ˆë‹¤. ë‹¤ìŒ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”. 
                    
ë¦¬ë·° í˜•ì‹:
## ğŸ” ì½”ë“œ ë¦¬ë·° ìš”ì•½
(ì „ë°˜ì ì¸ ë³€ê²½ì‚¬í•­ í‰ê°€)

## âœ… ì˜ëœ ë¶€ë¶„
(ì¢‹ì€ ì½”ë“œ íŒ¨í„´ì´ë‚˜ ê°œì„ ëœ ë¶€ë¶„)

## âš ï¸ ê°œì„  ì œì•ˆ
(ë²„ê·¸ ê°€ëŠ¥ì„±, ì„±ëŠ¥ ì´ìŠˆ, ì½”ë“œ ìŠ¤íƒ€ì¼ ê°œì„ ì  - êµ¬ì²´ì ì¸ ë¼ì¸ê³¼ í•¨ê»˜)

## ğŸ’¡ ì¶”ê°€ ê¶Œì¥ì‚¬í•­
(ì„ íƒì  ê°œì„  ì•„ì´ë””ì–´)

ë³€ê²½ì‚¬í•­:
${fullDiff}`
                  }]
                }],
                generationConfig: {
                  temperature: 0.3,
                  maxOutputTokens: 2048
                }
              })
            });
            
            const result = await response.json();
            let reviewText = '## ğŸ¤– AI ì½”ë“œ ë¦¬ë·°\n\n';
            
            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
              reviewText += result.candidates[0].content.parts[0].text;
            } else {
              reviewText += 'ë¦¬ë·°ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
              console.log('API Response:', JSON.stringify(result));
            }
            
            // Post comment on PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewText
            });
